package io.smallrye.faulttolerance.circuitbreaker.halfopen;

import static org.assertj.core.api.Assertions.assertThat;
import static org.assertj.core.api.Assertions.assertThatThrownBy;
import static org.awaitility.Awaitility.await;

import java.util.ArrayList;
import java.util.List;
import java.util.concurrent.ExecutionException;
import java.util.concurrent.ExecutorService;
import java.util.concurrent.Executors;
import java.util.concurrent.Future;
import java.util.concurrent.TimeUnit;

import org.eclipse.microprofile.faulttolerance.exceptions.CircuitBreakerOpenException;
import org.junit.jupiter.api.AfterEach;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;

import io.smallrye.faulttolerance.core.util.party.Party;
import io.smallrye.faulttolerance.util.FaultToleranceBasicTest;

@FaultToleranceBasicTest
public class CircuitBreakerHalfOpenTest {
    private ExecutorService executor;

    @BeforeEach
    public void setUp() {
        executor = Executors.newFixedThreadPool(HelloService.PROBE_ATTEMPTS);
    }

    @AfterEach
    public void tearDown() throws InterruptedException {
        executor.shutdownNow();
        executor.awaitTermination(1, TimeUnit.SECONDS);
    }

    @Test
    public void halfOpenCircuitBreakerRejectsExcessAttempts(HelloService service)
            throws ExecutionException, InterruptedException {
        // closed
        for (int i = 0; i < HelloService.ROLLING_WINDOW; i++) {
            assertThatThrownBy(() -> service.hello(true, null))
                    .isExactlyInstanceOf(IllegalArgumentException.class);
        }
        assertThat(service.getCounter()).hasValue(HelloService.ROLLING_WINDOW);

        // open
        for (int i = 0; i < 10; i++) {
            assertThatThrownBy(() -> service.hello(false, null))
                    .isExactlyInstanceOf(CircuitBreakerOpenException.class);
        }

        // await until half-open
        await().atMost(5 * HelloService.DELAY, TimeUnit.MILLISECONDS).ignoreExceptions().untilAsserted(() -> {
            assertThat(service.hello(false, null)).isEqualTo("Hello, world!");
        });

        // half-open, 1st probe invocation already succeeded
        Party party = Party.create(HelloService.PROBE_ATTEMPTS - 1);
        List<Future<String>> futures = new ArrayList<>();
        for (int i = 0; i < HelloService.PROBE_ATTEMPTS - 1; i++) {
            Future<String> future = executor.submit(() -> service.hello(false, party.participant()));
            futures.add(future);
        }

        party.organizer().waitForAll();

        // still half-open, but all allowed probe attempts are now running
        for (int i = 0; i < 10; i++) {
            assertThatThrownBy(() -> service.hello(false, null))
                    .isExactlyInstanceOf(CircuitBreakerOpenException.class);
        }

        party.organizer().disband();

        for (Future<String> future : futures) {
            assertThat(future.get()).isEqualTo("Hello, world!");
        }

        // closed
        assertThat(service.hello(false, null)).isEqualTo("Hello, world!");

        assertThat(service.getCounter()).hasValue(HelloService.ROLLING_WINDOW + HelloService.PROBE_ATTEMPTS + 1);
    }
}
