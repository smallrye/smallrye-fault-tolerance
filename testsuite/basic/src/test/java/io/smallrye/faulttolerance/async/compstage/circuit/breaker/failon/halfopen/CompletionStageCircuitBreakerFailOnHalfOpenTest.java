package io.smallrye.faulttolerance.async.compstage.circuit.breaker.failon.halfopen;

import io.smallrye.faulttolerance.util.FaultToleranceBasicTest;
import org.eclipse.microprofile.faulttolerance.exceptions.CircuitBreakerOpenException;
import org.junit.jupiter.api.Test;

import java.util.concurrent.ExecutionException;
import java.util.concurrent.TimeUnit;

import static org.assertj.core.api.Assertions.assertThat;
import static org.assertj.core.api.Assertions.assertThatThrownBy;
import static org.awaitility.Awaitility.await;

@FaultToleranceBasicTest
public class CompletionStageCircuitBreakerFailOnHalfOpenTest {
    @Test
    public void testCircuitBreakerOpens(AsyncHelloService service) throws InterruptedException {
        // closed
        for (int i = 1; i <= AsyncHelloService.ROLLING_WINDOW; i++) {
            assertThatThrownBy(() -> service.hello(new IllegalArgumentException()).toCompletableFuture().get())
                    .isExactlyInstanceOf(ExecutionException.class)
                    .hasCauseExactlyInstanceOf(IllegalArgumentException.class);
        }
        assertThat(service.getCounter()).hasValue(AsyncHelloService.ROLLING_WINDOW);

        // open
        assertThatThrownBy(() -> service.hello(null).toCompletableFuture().get())
                .isExactlyInstanceOf(ExecutionException.class)
                .hasCauseExactlyInstanceOf(CircuitBreakerOpenException.class);

        // await until half-open, then move to closed
        await().atMost(5 * AsyncHelloService.DELAY, TimeUnit.MILLISECONDS).untilAsserted(() -> {
            assertThatThrownBy(() -> service.hello(new IllegalStateException()).toCompletableFuture().get())
                    .isExactlyInstanceOf(ExecutionException.class)
                    .hasCauseExactlyInstanceOf(IllegalStateException.class);
        });

        // closed
        for (int i = 1; i <= 10; i++) {
            assertThatThrownBy(() -> service.hello(new IllegalStateException()).toCompletableFuture().get())
                    .isExactlyInstanceOf(ExecutionException.class)
                    .hasCauseExactlyInstanceOf(IllegalStateException.class);
        }
        assertThat(service.getCounter()).hasValue(AsyncHelloService.ROLLING_WINDOW + 11);
    }
}
